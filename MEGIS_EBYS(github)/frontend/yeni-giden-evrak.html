<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEGİS - Yeni Giden Evrak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .content { transition: margin-left 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Kenar Çubuğu (Sidebar) -->
    <aside id="sidebar" class="sidebar bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 z-30">
        <a href="anasayfa.html" class="text-white flex items-center space-x-2 px-4">
            <i data-lucide="file-archive-2" class="w-8 h-8"></i>
            <span class="text-2xl font-extrabold">MEGİS EBYS</span>
        </a>
        <nav>
            <a href="anasayfa.html" class="flex items-center space-x-3 hover:bg-gray-700 py-2.5 px-4 rounded-md transition duration-200"><i data-lucide="layout-dashboard"></i><span>Anasayfa</span></a>
            <a href="izin-yonetimi.html" class="flex items-center space-x-3 hover:bg-gray-700 py-2.5 px-4 rounded-md transition duration-200"><i data-lucide="calendar-check"></i><span>İzin Yönetimi</span></a>
            <a href="gelen-evrak.html" class="flex items-center space-x-3 hover:bg-gray-700 py-2.5 px-4 rounded-md transition duration-200"><i data-lucide="inbox"></i><span>Gelen Evrak</span></a>
            <a href="giden-evrak.html" class="flex items-center space-x-3 bg-gray-900 text-white py-2.5 px-4 rounded-md transition duration-200"><i data-lucide="send"></i><span>Giden Evrak</span></a>
            <a href="arsiv.html" class="flex items-center space-x-3 hover:bg-gray-700 py-2.5 px-4 rounded-md transition duration-200"><i data-lucide="archive"></i><span>Arşiv</span></a>
            <a id="link-kullanici-yonetimi" href="kullanici-yonetimi.html" class="flex items-center space-x-3 hover:bg-gray-700 py-2.5 px-4 rounded-md transition duration-200"><i data-lucide="users"></i><span>Kullanıcı Yönetimi</span></a>
            <a id="link-kurum-yonetimi" href="kurum-yonetimi.html" class="flex items-center space-x-3 hover:bg-gray-700 py-2.5 px-4 rounded-md transition duration-200"><i data-lucide="building-2"></i><span>Kurum Yönetimi</span></a>
            <a id="link-ayarlar" href="ayarlar.html" class="flex items-center space-x-3 hover:bg-gray-700 py-2.5 px-4 rounded-md transition duration-200"><i data-lucide="settings"></i><span>Ayarlar</span></a>
        </nav>
    </aside>

    <!-- Ana İçerik -->
    <div class="content flex-1 flex flex-col overflow-hidden">
        <header class="flex justify-between items-center p-4 bg-white border-b">
            <div class="flex items-center">
                <button id="menu-button" class="text-gray-500 focus:outline-none md:hidden"><i data-lucide="menu" class="w-6 h-6"></i></button>
                <div class="flex items-center">
                     <a href="giden-evrak.html" class="text-gray-500 hover:text-blue-600"><i data-lucide="arrow-left" class="w-5 h-5"></i></a>
                     <h1 class="text-2xl font-semibold text-gray-800 ml-4">Yeni Giden Evrak Oluştur</h1>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-f0f2f5 p-6">
            <form id="giden-evrak-form" class="bg-white p-6 rounded-xl shadow-md">
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="kurum-select" class="block text-sm font-medium text-gray-700 mb-1">Alıcı Kurum</label>
                            <select id="kurum-select" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required></select>
                        </div>
                        <div>
                            <label for="departman-select" class="block text-sm font-medium text-gray-700 mb-1">Alıcı Departman</label>
                            <select id="departman-select" name="disDepartmanId" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="evrak-turu-select" class="block text-sm font-medium text-gray-700 mb-1">Evrak Türü</label>
                            <select id="evrak-turu-select" name="evrakTuruId" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required></select>
                        </div>
                        <div>
                            <label for="evrak-tarihi" class="block text-sm font-medium text-gray-700 mb-1">Evrak Tarihi</label>
                            <input type="date" name="tarih" id="evrak-tarihi" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>
                    
                    <div>
                        <label for="ai-prompt" class="block text-sm font-medium text-gray-700 mb-1">Yapay Zeka Komutu</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="ai-prompt" placeholder="Örn: Okullara gönderilecek kar tatili duyurusu" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <button type="button" id="yapay-zeka-btn" class="flex-shrink-0 flex items-center gap-2 bg-purple-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                                <i data-lucide="sparkles" class="w-5 h-5"></i>
                                <span class="hidden md:inline">Oluştur</span>
                            </button>
                            <div id="loading-spinner" class="loader hidden"></div>
                        </div>
                    </div>

                    <div>
                        <label for="konu" class="block text-sm font-medium text-gray-700 mb-1">Konu / Metin</label>
                        <textarea id="konu" name="konu" rows="6" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dosya Eki</label>
                        <input type="file" id="file-upload" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>
                </div>
                <div class="flex justify-end items-center pt-6 mt-6 border-t">
                    <button type="submit" class="bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center gap-2">
                        <i data-lucide="send"></i>
                        <span>Gönder</span>
                    </button>
                </div>
            </form>
        </main>
    </div>

    <script src="auth.js"></script>
    <script>
        const API_BASE_URL = "https://localhost:7281";
        const currentUser = JSON.parse(localStorage.getItem('kullanici'));

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupEventListeners();
            populateKurumlarDropdown();
            populateEvrakTurleriDropdown();
        });

        function setupEventListeners() {
            document.getElementById('menu-button').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('-translate-x-full'));
            document.getElementById('kurum-select').addEventListener('change', (e) => populateDepartmanlarDropdown(e.target.value));
            document.getElementById('giden-evrak-form').addEventListener('submit', handleGonderSubmit);
            document.getElementById('yapay-zeka-btn').addEventListener('click', handleAIRequest);
        }

        async function populateKurumlarDropdown() {
            const select = document.getElementById('kurum-select');
            select.innerHTML = '<option value="">Kurum Seçiniz...</option>';
            try {
                const res = await fetch(`${API_BASE_URL}/api/Kurumlar`);
                if (!res.ok) throw new Error('Kurumlar yüklenemedi.');
                const kurumlar = await res.json();
                kurumlar.forEach(k => select.innerHTML += `<option value="${k.id}">${k.ad}</option>`);
            } catch (e) { console.error(e); }
        }

        async function populateDepartmanlarDropdown(kurumId) {
            const select = document.getElementById('departman-select');
            select.innerHTML = '<option value="">Departman Seçiniz...</option>';
            if (!kurumId) return;
            try {
                const res = await fetch(`${API_BASE_URL}/api/DisDepartmanlar/kurum/${kurumId}`);
                if (!res.ok) throw new Error('Departmanlar yüklenemedi.');
                const departmanlar = await res.json();
                departmanlar.forEach(d => select.innerHTML += `<option value="${d.id}">${d.ad}</option>`);
            } catch (e) { console.error(e); }
        }
        
        async function populateEvrakTurleriDropdown() {
            const select = document.getElementById('evrak-turu-select');
            select.innerHTML = '<option value="">Evrak Türü Seçiniz...</option>';
            try {
                const res = await fetch(`${API_BASE_URL}/api/EvrakTurleri`);
                if (!res.ok) throw new Error('Evrak Türleri yüklenemedi.');
                const turler = await res.json();
                turler.forEach(t => select.innerHTML += `<option value="${t.id}">${t.ad}</option>`);
            } catch (e) { console.error(e); }
        }

        async function handleGonderSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const evrakData = Object.fromEntries(formData.entries());

            if (!currentUser) {
                alert("Gönderen kullanıcı bilgisi bulunamadı. Lütfen tekrar giriş yapın.");
                return;
            }

            const fileInput = document.getElementById('file-upload');
            let dosyaYolu = null;
            if (fileInput.files.length > 0) {
                const fileFormData = new FormData();
                fileFormData.append('file', fileInput.files[0]);
                try {
                    const uploadResponse = await fetch(`${API_BASE_URL}/api/Dosyalar/upload`, {
                        method: 'POST',
                        body: fileFormData,
                    });
                    if (!uploadResponse.ok) throw new Error('Dosya yüklenemedi.');
                    const uploadResult = await uploadResponse.json();
                    dosyaYolu = uploadResult.filePath;
                } catch (error) {
                    alert(`Dosya yüklenirken bir hata oluştu: ${error.message}`);
                    return;
                }
            }

            const kurumSelect = document.getElementById('kurum-select');
            const seciliKurumAdi = kurumSelect.options[kurumSelect.selectedIndex].text;

            evrakData.yonu = 1;
            evrakData.durum = 6;
            evrakData.evrakTuruId = parseInt(evrakData.evrakTuruId);
            evrakData.tarih = new Date().toISOString();
            evrakData.dahiliMi = false; // Dış kuruma gönderim
            evrakData.gonderenKullaniciId = currentUser.id;
            evrakData.ilgiliKurum = seciliKurumAdi;
            evrakData.dosyaYolu = dosyaYolu;
            delete evrakData.disDepartmanId;

            try {
                const response = await fetch(`${API_BASE_URL}/api/Evraklar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(evrakData)
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Evrak gönderilemedi: ${errorText}`);
                }
                alert("Evrak başarıyla gönderildi!");
                window.location.href = 'giden-evrak.html';
            } catch (error) {
                console.error('Evrak Gönderme Hatası:', error);
                alert(`Evrak gönderilirken bir hata oluştu.\n\nDetay: ${error.message}`);
            }
        }

        async function handleAIRequest() {
            const konuTextarea = document.getElementById('konu');
            const promptInput = document.getElementById('ai-prompt');
            const promptText = promptInput.value;
            const aiButton = document.getElementById('yapay-zeka-btn');
            const spinner = document.getElementById('loading-spinner');

            if (!promptText.trim()) {
                alert("Lütfen yapay zekaya bir komut girin.");
                return;
            }

            aiButton.disabled = true;
            spinner.classList.remove('hidden');
            aiButton.classList.add('hidden');

            try {
                const fullPrompt = `Sen bir devlet memurusun. Sana verilen anahtar kelimeleri kullanarak, bir kurumdan başka bir kuruma gönderilecek resmi bir yazı metni oluştur. Metin sadece resmi içeriği kapsamalı, selamlama veya "saygılarımla" gibi kapanış ifadeleri içermemeli. Anahtar kelimeler: "${promptText}"`;
                
                const response = await fetch(`${API_BASE_URL}/api/AI/GenerateText`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: fullPrompt })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Yapay zeka servisinden hata alındı: ${errorText}`);
                }

                const result = await response.json();
                konuTextarea.value = result.generatedText;

            } catch (error) {
                console.error("Yapay Zeka Hatası:", error);
                alert(`Metin oluşturulurken bir hata oluştu: ${error.message}`);
            } finally {
                aiButton.disabled = false;
                spinner.classList.add('hidden');
                aiButton.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
